<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="keywords" content="key1, key2" />
<meta name="description" content=””>
<meta name="author" content="nate">
<meta name="author" content="nate &lt;jiwanger@126.com&gt;">
<link href="images/favicon.ico" rel="bookmark" type="image/x-icon" />
<link href="images/favicon.ico" rel="icon" type="image/x-icon" />
<link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
<title>NATE--笔记--SOURCE--CODE</title>
<!-- Bootstrap -->
<link href="../support/bootstrap/theme/yeti-bootstrap.min.css"
	rel="stylesheet">
<!-- 
<link href="../support/bootstrap/css/bootstrap.css" rel="stylesheet">
-->
<link type="text/css" rel="stylesheet"
	href="../support/syntaxhighlighter/styles/shCoreDefault.css" />
<link href="../commons/css/common.css" rel="stylesheet">
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
	<!-- nav start -->
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target="#bs-example-navbar-collapse-1">
					<span class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="../index.html">
					<img src="../commons/images/icon.png">
				</a>
			</div>

			<div class="collapse navbar-collapse"
				id="bs-example-navbar-collapse-1">
				<ul id="my-nav" class="nav navbar-nav">

				</ul>
			</div>
		</div>
	</nav>
	<!-- nav end -->


	<div class="container">
		<div class="row">
			<!-- left-menu start -->
			<div class="col-md-3">
				<div class="panel panel-default"
					style="position: fixed; top: 70px; width: 260px; height: 85%; overflow: auto; float: left;">
					<div class="panel-heading">
						<h3 class="panel-title">SOURCE-CODE</h3>
					</div>
					<div class="list-group">
						<a href="#" class="list-group-item">简介</a>
						<a href="#src-compile" class="list-group-item">
							Android 源代码编译<span class="badge">1</span>
						</a>
						<a href="#src-hardware-abstract-layer" class="list-group-item">
							硬件抽象层<span class="badge">2</span>
						</a>
						<a href="#src-" class="list-group-item">
							智能指针<span class="badge">3</span>
						</a>
						<a href="#src-" class="list-group-item">
							Logger 日志系统<span class="badge">4</span>
						</a>
						<a href="#src-" class="list-group-item">
							Binder 进程间通信系统<span class="badge">5</span>
						</a>
						<a href="#src-" class="list-group-item">
							Ashmem 匿名共享内存系统<span class="badge">6</span>
						</a>
						<a href="#src-" class="list-group-item">
							Activity 组件的启动过程<span class="badge">7</span>
						</a>
						<a href="#src-" class="list-group-item">
							Service 组件的启动过程<span class="badge">8</span>
						</a>
						<a href="#src-" class="list-group-item">
							Android 系统广播机制<span class="badge">9</span>
						</a>
						<a href="#src-" class="list-group-item">
							Content Provider 组件的实现原理<span class="badge">10</span>
						</a>
						<a href="#src-" class="list-group-item">
							Zygote和System进程的启动过程<span class="badge">11</span>
						</a>
						<a href="#src-" class="list-group-item">
							应用程序进程的启动过程<span class="badge">12</span>
						</a>
						<a href="#src-" class="list-group-item">
							应用程序的消息处理机制<span class="badge">13</span>
						</a>
						<a href="#src-" class="list-group-item">
							应用程序的键盘消息处理机制<span class="badge">14</span>
						</a>
						<a href="#src-" class="list-group-item">
							应用程序线程的消息循环模型<span class="badge">15</span>
						</a>
						<a href="#src-" class="list-group-item">
							应用程序的安装和显示过程<span class="badge">16</span>
						</a>
					</div>
				</div>
			</div>
			<!-- left-menu over -->
		</div>
	</div>


	<div class="container" style="margin-top: 70px;">
		<div class="row">
			<div class="col-md-9 col-md-push-3" style="float: left;">
				<!-- item start -->
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">简介</h3>
					</div>
					<div class="panel-body">
						<div class="text-primary">
							<p class="h4">本文是罗升阳的《Android 系统源代码情景分析(修订版)》学习笔记，源代码使用的是
								android-2.3.1_r1 的版本, 内核源码使用的是 android-goldfish-2.6.29 版本。
							<p>
							<p>本文的測試环境:</p>
							<ul>
								<li>OS: Linux Mint 17 (32位)</li>
								<li>JAVA: 1.6.0_45(本人常用jdk1.8.0_65版本，要换成1.6的java版本)</li>
								<li>gcc/g++: 4.4(系统的gcc/g++ 的版本太高，要换成4.4的版本)</li>
							</ul>
						</div>
					</div>
				</div>
				<!-- item over -->

				<!-- item start -->
				<a class="offset" id="src-compile"></a>
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">第一章 Android 源代码编译</h3>
					</div>
					<div class="panel-body">
						<p>
							<a href="#src-code">Android 源代码</a>
							和
							<a href="#src-kernel-code">Android 内核源代码</a>
							的下载, 编译，和运行。
							<a href="#src-first-app">第一个 Android 应用程序的开发</a>

						</p>

						<a class="offset" id="src-code"></a>
						<div class="sub-item">
							<h5 class="text-primary">Android 源代码下载，编译，运行</h5>
							<ol>
								<li>
									<p>下载编译要使用的工具和依赖包: git , jdk6 和其它信赖包。</p>
									<pre class="brush: bash;">
# git 和 jdk 6 自行安装
# 其它依赖包安装，libwxgtk2.6-dev 为可选的
$ sudo apt-get install flex bison gperf libsdl-dev libesd0-dev libwxgtk2.6-dev　build-essential \
	zip curl valgrind
</pre>
								</li>
								<li>
									下载 Android 源代码，这些文件应该从 google 下载，但是基于国内环境，这里使用中科大源下载
									<pre class="brush: bash;">
# 1.下载 repo 工具，此文件封装了用来下载 Android 源代码使用的 git 命令
$ wget https://dl-ssl.google.com/dl/googlesource/git-repo/repo
# 上面的地址修改为:
$ wget https://storage-googleapis.lug.ustc.edu.cn/git-repo-downloads/repo

# 2.修改权限为可执行，并复制到可从 $PATH 找到的目录:
$ chmod a+x repo
$ mv repo ~/installed/bin/

# 3.创建一个空目录，用来下载源码，并开始下载,这里指定为 android-2.3.1_r1 版本
$ mkdir ~/Android
$ mkdir ~/Android/android-2.3.1_r1/
$ cd ~/Android/android-2.3.1_r1/
$ repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-2.3.1_r1
$ repo sync -j4

# 4.此下载可能持续时间长，如果中断，使用下面的命令同步(-j4 表示最大并发数4)
$ repo sync -j4
</pre>
								</li>
								<li>
									编译 android 源代码
									<pre class="brush: bash;">
$ make
# 因为我们在 32 位机器上编译，显示:　You are attempting to build on a 32-bit system. 错误，
# 主线上的源代码是在64位机器上编译的，要做几处修改:
# 1.修改　build/core/main.mk 文件:
#	ifneq (64,$(findstring 64,$(build_arch)))
# 修改为:
#	ifneq (i686,$(findstring i686,$(build_arch)))

# 2.修改 external/clearsilver/cgi/Android.mk, external/clearsilver/cs/Android.mk, 
#	external/clearsilver/java-jni/Android.mk, external/clearsilver/util/Android.mk 这4个文件：
#	LOCAL_CFLAGS += -m64
#	LOCAL_LDFLAGS += -m64
# 修改为:
#	LOCAL_CFLAGS += -m32
#	LOCAL_LDFLAGS += -m32

# 编译过程碰到的其它错误:
# 1.gcc 和 g++ 版本太高
# 解决方法:
$ sudo apt-get install gcc-4.4
$ sudo apt-get install g++-4.4
$ sudo ln -s /usr/bin/gcc-4.4 /usr/bin/gcc
$ sudo ln -s /usr/bin/gcc-4.4 /usr/bin/gcc

# 2./bin/bash: cc: command not found
# 解决方法:
$ sudo ln -s /usr/bin/gcc /usr/bin/cc

# 3.dalvik/vm/native/dalvik_system_Zygote.c:191: error: storage size of ‘rlim’ isn’t known
# 解决方法: 添加头文件 #include &lt;sys/resource.h> 到以下文件
# 	dalvik/vm/native/dalvik_system_Zygote.c

# 4.make: *** [out/host/linux-x86/obj/EXECUTABLES/adb_intermediates/adb] Error 1
# 解决方法:
$ sudo apt-get install libncurses5-dev:i386

# 5.BEGIN failed--compilation aborted at external/webkit/WebCore/dom/make_names.pl line 38. 
# 解决方法:
$ sudo apt-get install libswitch-perl
</pre>
								</li>

								<li>
									编译成功后打包成 sdk
									<pre class="brush: bash;">$ make sdk</pre>
								</li>
								<li>
									运行 Android 模拟器
									<pre class="brush: bash;">
# Android 模拟器 -- emulator, 位于 ~/Android/android-2.3.1_r1/out/host/linux-x86/bin　目录中
# 为了方便使用和区分，在 PATH 指定了的目录中建立一个链接:
$ ln -s ~/Android/android-2.3.1_r1/out/host/linux-x86/bin/emulator ~/installed/bin/myemulator
# 运行模拟器要4个文件, zImage, system.img, userdata.img ramdisk,img
# zImage -- 为Linux内核镜像文件, 如不指定，这个文件使用的是:
#	~/Android/android-2.3.1_r1/prebuilt/android-arm/kernel/kernel-qemu
# 后面的３个都是Android系统镜像文件，位于 ~/Android/android-2.3.1_r1/out/trget/product/generic/ 目录
$ export ANDROID_PRODUCT_OUT=~/Android/android-2.3.1_r1/out/target/product/generic
$ myemulator

# 如果不导入 ANDROID_PRODUCT_OUT 这个环境变量，要分别指出上述 4 个文件的位置
$ myemulator -kernel ./prebuilt/android-arm/kernel/kernel-qemu \
	-system ./out/target/product/generic/system.img \
	-data ./out/target/product/generic/userdata.img \
	-ramdisk ./out/target/product/generic/ramdisk.img
</pre>
								</li>
							</ol>
						</div>

						<a class="offset" id="src-kernel-code"></a>
						<div class="sub-item">
							<h5 class="text-primary">Android 内核源代码下载，编译，运行</h5>
							<ol>
								<li>
									下载 Android 内核源代码，这些文件应该从 google 下载，但是基于国内环境，这里使用清华大学源下载
									<pre class="brush: bash;">
$ mkdir ~/Android/kernel
$ git clone http://android.googlesource.com/kernel/goldfish.git
# 上面的地址修改为:
$ git clone https://aosp.tuna.tsinghua.edu.cn/kernel/goldfish.git

$ cd goldfish
# 查看有哪些支线代码
$ git branch -a
# 因为我们使用 Android 模拟器来运行 Android 系统，选择使用 android-goldfish-2.6.29 支线
$ git checkout remotes/origin/android-goldfish-2.6.29
</pre>
								</li>
								<li>
									编译 Android 内核源代码
									<pre class="brush: bash;">
$ export PATH=$PATH:~/Android/android-2.3.1_r1/prebuilt/linux-x86/toolchain/arm-eabi-4.4.3/bin

$ make goldfish_defconfig
$ make
</pre>
								</li>
								<li>
									运行 Android 模拟器
									<pre class="brush: bash;">
$ cd ~/Android/android-2.3.1_r1
# kernel 指定编译生成的 zImage 文件位置
$ myemulator -kernel ../kernel/goldfish/arch/arm/boot/zImage \
	-system ./out/target/product/generic/system.img \
	-data ./out/target/product/generic/userdata.img \
	-ramdisk ./out/target/product/generic/ramdisk.img

# 查看 kernel 是否是自己编译的版本
$ adb shell
$ cd /proc
$ cat version
# 显示的 kernel 信息: Linux version 2.6.29-g4bb8fa0-dirty (nate@nate-pc) 
# (gcc version 4.4.3 (GCC) ) #1 Thu Feb 9 13:46:19 CST 2017
</pre>
								</li>
							</ol>
						</div>

						<a class="offset" id="src-first-app"></a>
						<div class="sub-item">
							<h5 class="text-primary">开发第一个 Android 应用程序</h5>
							<pre class="brush: bash;">
# mmm 命令是 Android 源代码工程提供用来单独编译某一个模块的工具，
# 并提供 make snod 命令来纯粹执行打包 Android 系统镜像文件　system.img 的操作。
#  要使用　mmm 命令，要执行 ./build/envsetup.sh 文件: 
$ source ./build/envsetup.sh

# 使用 mmm 命令编译项目，比如：HelloAndroid 项目，此项目下要有 Android.mk 文件
# 编译完成后，在 out/target/product/generic/system/app 目录生成　HelloAndroid.apk　文件
$ mmm ./packages/experimental/HelloAndroid/

# 使用 make snod 命令重新打包 Android 系统镜像文件，out/target/product/generic 目录下重新生成　system.img 文件
$ make snod

# 使用 myemulator 启动模拟器，可看到 HelloAndroid 的应用
$ myemulator
</pre>
						</div>
					</div>
				</div>
				<!-- item over -->

				<!-- item start -->
				<a class="offset" id="src-hardware-abstract-layer"></a>
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">第二章 硬件抽象层</h3>
					</div>
					<div class="panel-body">
						<p>Android系统的硬件抽象层（Hardware Abstract
							Layer，HAL）运行在用户空间中，它向下屏蔽硬件驱动模块的实现细节，向上提供硬件访问服务。通过硬件抽象层，Android系统分两层来支持硬件设备，其中一层实现在用户空间中，另一层实现在内核空间中。</p>
						<p>介绍Android系统的硬件抽象层的目的在于认识Android系统的体系结构，因为它的实现和使用依次涉及Android系统的硬件驱动模块、硬件抽象层、外部库和运行时库层、应用程序框架层和应用程序层等。将通过一个实例来介绍硬件抽象层：</p>
						<p class="alert alert-success">首先在Android系统的内核空间中为一个硬件开发驱动程序，接着在用户空间中为该硬件添加一个硬件抽象层模块，并且在应用程序框架层中添加一个硬件访问服务，最后开发一个应用程序来访问该硬件服务。</p>
					</div>
				</div>
				<!-- item over -->

				<!-- item start -->
				<a class="offset" id="src-"></a>
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title"></h3>
					</div>
					<div class="panel-body"></div>
				</div>
				<!-- item over -->
			</div>
		</div>
	</div>

	<div class="btn-group-vertical bottom-button">
		<a href="#" type="button"
			class="btn btn-default dropdown-toggle dropup" data-toggle="dropup">
			<span class="caret"></span>
		</a>
		<a href="#" type="button"
			class="btn btn-default dropdown-toggle btn-primary"
			data-toggle="dropup"> TOP </a>
	</div>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="../support/jquery/jquery-3.1.1.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="../support/bootstrap/js/bootstrap.min.js"></script>
	<script src="../support/syntaxhighlighter/scripts/shCore.js"></script>
	<script src="../support/syntaxhighlighter/scripts/shBrushBash.js"></script>
	<script src="../support/syntaxhighlighter/scripts/shBrushXml.js"></script>
	<script src="../support/syntaxhighlighter/scripts/shBrushJava.js"></script>
	<script src="res/menu.js"></script>
	<script src="../commons/js/common.js"></script>
</body>
</html>
